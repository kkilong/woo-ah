<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>키워드 입력</title>
</head>
<body>

<h2 id="title"></h2>

작성자:
<select id="author"></select>

<br><br>

키워드:
<input id="keyword">

<br><br>

<button onclick="save()">제출</button>

<p id="msg"></p>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script>
  // 참가자 목록 (나중에 이름으로 바꿔도 됨)
const players = [
  "1","2","3","4","5","6","7",
  "8","9","10","11","12","13","14"
];

// URL에서 대상자 가져오기
const params = new URLSearchParams(location.search);
const target = params.get("target");

document.getElementById("title").innerText =
  "참가자 " + target + "에게 키워드 입력";

// 드롭다운 생성 (target 제외)
const select = document.getElementById("author");

players.forEach(p => {
  if (p !== target) {
    const option = document.createElement("option");
    option.value = p;
    option.textContent = p;
    select.appendChild(option);
  }
});
const firebaseConfig = {
  apiKey: "AIzaSyAXLrGMg60B_RB06jQFqwAX3_opHnBhUP8",
    authDomain: "trpg-keyword-2026.firebaseapp.com",
    projectId: "trpg-keyword-2026",
    storageBucket: "trpg-keyword-2026.firebasestorage.app",
    messagingSenderId: "159506261526",
    appId: "1:159506261526:web:4bbd67d8b7a9fb969e7737",
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

async function save() {
  const author = document.getElementById("author").value;
  const keyword = document.getElementById("keyword").value.trim();
  const msg = document.getElementById("msg");

  msg.innerText = "";
  msg.style.color = "red";

  if (!keyword) {
    msg.innerText = "키워드를 입력하세요";
    return;
  }

  try {

    // 1️⃣ 대상에게 이미 같은 키워드가 있는지
    const sameTarget = await db.collection("keywords")
      .where("target", "==", target)
      .where("keyword", "==", keyword)
      .get();

    if (!sameTarget.empty) {
      msg.innerText = "이미 접수된 키워드입니다";
      return;
    }


    // 2️⃣ 같은 작성자가 이 대상에게 이미 제출했는지
    const alreadySubmitted = await db.collection("keywords")
      .where("author", "==", author)
      .where("target", "==", target)
      .get();

    if (!alreadySubmitted.empty) {
      msg.innerText = "이미 해당 참가자에게 키워드를 제출하셨습니다";
      return;
    }


    // 3️⃣ 같은 작성자가 다른 대상에게 같은 키워드 썼는지
    const sameAuthorKeyword = await db.collection("keywords")
      .where("author", "==", author)
      .where("keyword", "==", keyword)
      .get();

    if (!sameAuthorKeyword.empty) {
      msg.innerText = "중복 키워드 제출이 불가능합니다";
      return;
    }


    // ✅ 저장
    await db.collection("keywords").add({
      author: author,
      target: target,
      keyword: keyword,
      createdAt: new Date()
    });

    msg.style.color = "green";
    msg.innerText = "저장되었습니다";
    document.getElementById("keyword").value = "";

  } catch (e) {
    msg.innerText = "에러: " + e.message;
  }
}
</script>

</body>
</html>
