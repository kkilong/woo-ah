<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>í‚¤ì›Œë“œ ì…ë ¥</title>
</head>
<body>

<h2 id="title"></h2>

ì‘ì„±ì:
<select id="author"></select>

<br><br>

í‚¤ì›Œë“œ:
<input id="keyword">

<br><br>

<button onclick="save()">ì œì¶œ</button>

<p id="msg"></p>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script>
  // ì°¸ê°€ì ëª©ë¡ (ë‚˜ì¤‘ì— ì´ë¦„ìœ¼ë¡œ ë°”ê¿”ë„ ë¨)
const playerName = players[target].name;

// URLì—ì„œ ëŒ€ìƒì ê°€ì ¸ì˜¤ê¸°
const params = new URLSearchParams(location.search);
const target = params.get("target");

document.getElementById("title").innerText =
  playerName + "ì—ê²Œ í‚¤ì›Œë“œ ì…ë ¥";

// ë“œë¡­ë‹¤ìš´ ìƒì„± (target ì œì™¸)
const select = document.getElementById("author");

Object.keys(players).forEach(p => {
  if (p !== target) {
    const option = document.createElement("option");
    option.value = p; // Firestoreì—ëŠ” ë²ˆí˜¸ ì €ì¥ (ì•ˆì „)
    option.textContent = players[p].name; // í™”ë©´ì—ëŠ” ì´ë¦„
    select.appendChild(option);
  }
});
const firebaseConfig = {
  apiKey: "AIzaSyAXLrGMg60B_RB06jQFqwAX3_opHnBhUP8",
    authDomain: "trpg-keyword-2026.firebaseapp.com",
    projectId: "trpg-keyword-2026",
    storageBucket: "trpg-keyword-2026.firebasestorage.app",
    messagingSenderId: "159506261526",
    appId: "1:159506261526:web:4bbd67d8b7a9fb969e7737",
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

async function save() {
  const author = document.getElementById("author").value;
  const keyword = document.getElementById("keyword").value.trim();
  const msg = document.getElementById("msg");

  msg.innerText = "";
  msg.style.color = "red";

  if (!keyword) {
    msg.innerText = "í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”";
    return;
  }

  try {

    // 1ï¸âƒ£ ëŒ€ìƒì—ê²Œ ì´ë¯¸ ê°™ì€ í‚¤ì›Œë“œê°€ ìˆëŠ”ì§€ ê²€ì‚¬
    const sameTarget = await db.collection("keywords")
      .where("target", "==", target)
      .where("keyword", "==", keyword)
      .get();

    if (!sameTarget.empty) {
      // ë‹¨, ê·¸ê²Œ ìê¸° ìì‹ ì˜ ê¸°ì¡´ ì œì¶œì´ë©´ í—ˆìš©í•´ì•¼ í•¨
      let conflict = false;
      sameTarget.forEach(doc => {
        if (doc.data().author !== author) {
          conflict = true;
        }
      });

      if (conflict) {
        msg.innerText = "ì´ë¯¸ ì ‘ìˆ˜ëœ í‚¤ì›Œë“œì…ë‹ˆë‹¤";
        return;
      }
    }


    // 2ï¸âƒ£ ê°™ì€ ì‘ì„±ìê°€ ë‹¤ë¥¸ ëŒ€ìƒì—ê²Œ ê°™ì€ í‚¤ì›Œë“œ ì‚¬ìš©í–ˆëŠ”ì§€
    const sameAuthorKeyword = await db.collection("keywords")
      .where("author", "==", author)
      .where("keyword", "==", keyword)
      .get();

    let usedElsewhere = false;
    sameAuthorKeyword.forEach(doc => {
      if (doc.data().target !== target) {
        usedElsewhere = true;
      }
    });

    if (usedElsewhere) {
      msg.innerText = "ì¤‘ë³µ í‚¤ì›Œë“œ ì œì¶œì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤";
      return;
    }


    // 3ï¸âƒ£ ì´ë¯¸ ì´ author â†’ target ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸
    const existing = await db.collection("keywords")
      .where("author", "==", author)
      .where("target", "==", target)
      .get();


    if (!existing.empty) {
      // ğŸ” ìˆ˜ì •(update)
      const docId = existing.docs[0].id;

      await db.collection("keywords").doc(docId).update({
        keyword: keyword,
        updatedAt: new Date()
      });

      msg.style.color = "green";
      msg.innerText = "ê¸°ì¡´ í‚¤ì›Œë“œë¥¼ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤";
      return;
    }


    // 4ï¸âƒ£ ì—†ìœ¼ë©´ ìƒˆë¡œ ì €ì¥
    await db.collection("keywords").add({
      author: author,
      target: target,
      keyword: keyword,
      createdAt: new Date()
    });

    msg.style.color = "green";
    msg.innerText = "ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤";
    document.getElementById("keyword").value = "";

  } catch (e) {
    msg.innerText = "ì—ëŸ¬: " + e.message;
  }
}
</script>

</body>
</html>
